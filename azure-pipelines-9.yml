# ---------------------- CD PIPELINE ----------------------

resources:
  pipelines:
    - pipeline: WebAppCI
      source: Learn14-know.WebApp
      trigger:
        branches:
          include:
            - main

variables:
  PROJECT_NAME: 'WebApp'

  # App Names
  APP_DEV: 'app-dev-app'
  APP_STG: 'app-staging-app'
  APP_PRD: 'app-prod-app'

  # Resource Groups
  RG_DEV: 'RG-DEV'
  RG_STAGING: 'RG-STAGING'
  RG_PRD: 'RG-PROD-App'

  # Azure service connection
  AZURE_SERVICE_CONNECTION: 'Appconnec'

  # Artifact
  ARTIFACT_NAME: 'drop'

# ---------------------- DEPLOY DEV ----------------------
stages:
- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  jobs:
  - deployment: DeployDev
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: "Download Latest CI Artifact"
            inputs:
              buildType: 'specific'
              project: $(PROJECT_NAME)
              pipeline: 'Learn14-know.WebApp'
              runVersion: 'latest'
              artifact: $(ARTIFACT_NAME)
              path: $(Pipeline.Workspace)/drop

          - task: AzureWebApp@1
            displayName: "Deploy to Dev"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_DEV)
              resourceGroupName: $(RG_DEV)
              package: "$(Pipeline.Workspace)/drop/DotNetWebApp.zip"

# ---------------------- DEPLOY STAGING ----------------------
- stage: Deploy_Staging
  displayName: "Deploy to Staging"
  dependsOn: Deploy_Dev
  jobs:
  - deployment: DeployStaging
    environment: staging
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: "Download Latest CI Artifact"
            inputs:
              buildType: 'specific'
              project: $(PROJECT_NAME)
              pipeline: 'Learn14-know.WebApp'
              runVersion: 'latest'
              artifact: $(ARTIFACT_NAME)
              path: $(Pipeline.Workspace)/drop

          - task: AzureRmWebAppDeployment@5
            displayName: "Deploy to Green Slot - Staging"
            inputs:
              ConnectionType: 'AzureRM'
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appType: 'webAppLinux'
              WebAppName: $(APP_STG)
              deployToSlotOrASE: true
              ResourceGroupName: $(RG_STAGING)
              SlotName: 'green'
              packageForLinux: "$(Pipeline.Workspace)/drop/DotNetWebApp.zip"
              RuntimeStack: 'DOTNETCORE|8.0'
              DeploymentTypeLinux: 'oneDeploy'

          - task: AzureCLI@2
            displayName: "Health Check - Staging Green Slot"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                SLOT_URL="https://$(APP_STG)-green.azurewebsites.net/health"
                echo "Waiting for staging green slot to be healthy..."
                for i in {1..30}; do
                  STATUS=$(curl -s -o /dev/null -w "%{http_code}" $SLOT_URL || echo 000)
                  if [ "$STATUS" -eq 200 ]; then
                    echo "Green slot is healthy!"
                    exit 0
                  else
                    echo "Health check failed (status=$STATUS). Retry in 10s..."
                    sleep 10
                  fi
                done
                echo "ERROR: Green slot did not become healthy."
                exit 1

          - task: AzureWebApp@1
            displayName: "Deploy Staging Production Slot (Optional)"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_STG)
              resourceGroupName: $(RG_STAGING)
              package: "$(Pipeline.Workspace)/drop/DotNetWebApp.zip"

# ---------------------- DEPLOY PRODUCTION (BLUE/GREEN) ----------------------
- stage: Deploy_Prod
  displayName: "Deploy to Production"
  dependsOn: Deploy_Staging
  jobs:
  - deployment: DeployProd
    environment: production
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: "Download Latest CI Artifact"
            inputs:
              buildType: 'specific'
              project: $(PROJECT_NAME)
              pipeline: 'Learn14-know.WebApp'
              runVersion: 'latest'
              artifact: $(ARTIFACT_NAME)
              path: $(Pipeline.Workspace)/drop

          - task: AzureWebApp@1
            displayName: "Deploy to Blue Slot"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_PRD)
              resourceGroupName: $(RG_PRD)
              slotName: blue
              package: "$(Pipeline.Workspace)/drop/DotNetWebApp.zip"

          - task: AzureCLI@2
            displayName: "Health Check - Blue Slot"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                SLOT_URL="https://$(APP_PRD)-blue.azurewebsites.net/"
                echo "Waiting for blue slot to be healthy..."
                for i in {1..30}; do
                  STATUS=$(curl -s -o /dev/null -w "%{http_code}" $SLOT_URL || echo 000)
                  if [ "$STATUS" -eq 200 ]; then
                    echo "Blue slot is healthy!"
                    exit 0
                  else
                    echo "Health check failed (status=$STATUS). Retry in 10s..."
                    sleep 10
                  fi
                done
                echo "ERROR: Blue slot did not become healthy."
                exit 1

          - task: AzureCLI@2
            displayName: "Swap Blue Slot to Production"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "Starting blue â†’ production slot swap..."
                az webapp deployment slot swap \
                  --name $(APP_PRD) \
                  --resource-group $(RG_PRD) \
                  --slot blue \
                  --target-slot production
                echo "Swap completed successfully."
