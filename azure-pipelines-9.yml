
resources:
  pipelines:
    - pipeline: WebAppCI
      source: Learn14-know.WebApp
      trigger:
        branches:
          include:
            - main

variables:
  PROJECT_NAME: 'WebApp'

  # App Names
  APP_DEV: 'app-dev-app'
  APP_STG: 'app-staging-app'
  APP_PRD: 'app-prod-app'

  # Resource Groups
  RG_DEV: 'RG-DEV'
  RG_STAGING: 'RG-STAGING'
  RG_PRD: 'RG-PROD-App'

  # Azure service connection
  AZURE_SERVICE_CONNECTION: 'Appconnec'

  # Artifact
  ARTIFACT_NAME: 'drop'

stages:
- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  jobs:
    - deployment: DeployDev
      environment: dev
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadPipelineArtifact@2
                displayName: "Download Artifact"
                inputs:
                  buildType: 'specific'
                  project: $(PROJECT_NAME)
                  pipeline: 'Learn14-know.WebApp'
                  runVersion: 'latest'
                  artifact: $(ARTIFACT_NAME)
                  path: $(Pipeline.Workspace)/drop

              - task: AzureRmWebAppDeployment@5
                displayName: "Deploy to Dev"
                inputs:
                  ConnectionType: 'AzureRM'
                  azureSubscription: $(AZURE_SERVICE_CONNECTION)
                  appType: 'webAppLinux'
                  WebAppName: $(APP_DEV)
                  ResourceGroupName: $(RG_DEV)
                  packageForLinux: "$(Pipeline.Workspace)/drop/DotNetWebApp.zip"
                  RuntimeStack: 'DOTNETCORE|8.0'
                  DeploymentTypeLinux: 'oneDeploy'
                  StartupCommand: 'dotnet DotNetWebApp.dll'




- stage: Deploy_Staging
  displayName: "Deploy to Staging"
  dependsOn: Deploy_Dev
  jobs:
  - deployment: DeployStaging
    environment: staging
    strategy:
      runOnce:
        deploy:
          steps:
            - task: DownloadPipelineArtifact@2
              displayName: "Download Latest CI Artifact"
              inputs:
                buildType: 'specific'
                project: $(PROJECT_NAME)
                pipeline: 'Learn14-know.WebApp'
                runVersion: 'latest'
                artifact: $(ARTIFACT_NAME)
                path: $(Pipeline.Workspace)/drop

            # Deploy to green slot
            - task: AzureRmWebAppDeployment@5
              displayName: "Deploy to Green Slot (Staging)"
              inputs:
                ConnectionType: 'AzureRM'
                azureSubscription: $(AZURE_SERVICE_CONNECTION)
                appType: 'webAppLinux'
                WebAppName: $(APP_STG)
                ResourceGroupName: $(RG_STAGING)
                SlotName: 'green'
                packageForLinux: "$(Pipeline.Workspace)/drop/DotNetWebApp.zip"
                RuntimeStack: 'DOTNETCORE|8.0'
                DeploymentTypeLinux: 'oneDeploy'
                StartupCommand: 'dotnet DotNetWebApp.dll'

           
            - task: AzurePowerShell@5
              displayName: "Health Check – Green Slot (Staging)"
              inputs:
                azureSubscription: $(AZURE_SERVICE_CONNECTION)
                ScriptType: InlineScript
                Inline: |
                  $slotUrl = "https://$(APP_STG)-green.azurewebsites.net/health"
                  Write-Host "Checking Green slot health: $slotUrl"

                  $maxRetries = 30
                  $delaySeconds = 10

                  for ($i = 1; $i -le $maxRetries; $i++) {
                      try {
                          $response = Invoke-WebRequest -Uri $slotUrl -TimeoutSec 10 -UseBasicParsing
                          if ($response.StatusCode -eq 200) {
                              Write-Host " Green slot is healthy"
                              exit 0
                          }
                          Write-Host "Attempt $i → Status=$($response.StatusCode), retrying..."
                      } catch {
                          Write-Host "Attempt $i → Health check failed, retrying..."
                      }
                      Start-Sleep -Seconds $delaySeconds
                  }

                  Write-Error " Green slot did not become healthy after $maxRetries attempts"
                  exit 1
                azurePowerShellVersion: LatestVersion

            
            - task: AzureAppServiceManage@0
              displayName: "Swap Green → Production (Staging)"
              inputs:
                azureSubscription: $(AZURE_SERVICE_CONNECTION)
                Action: 'Swap Slots'
                WebAppName: $(APP_STG)
                ResourceGroupName: $(RG_STAGING)
                SourceSlot: 'green'

- stage: Deploy_Prod
  displayName: "Deploy to Production"
  dependsOn: Deploy_Staging
  jobs:
  - deployment: DeployProd
    environment: production
    strategy:
      runOnce:
        deploy:
          steps:
            - task: DownloadPipelineArtifact@2
              displayName: "Download Latest CI Artifact"
              inputs:
                buildType: 'specific'
                project: $(PROJECT_NAME)
                pipeline: 'Learn14-know.WebApp'
                runVersion: 'latest'
                artifact: $(ARTIFACT_NAME)
                path: $(Pipeline.Workspace)/drop

            
            - task: AzureRmWebAppDeployment@5
              displayName: "Deploy to Blue Slot (Production)"
              inputs:
                ConnectionType: 'AzureRM'
                azureSubscription: $(AZURE_SERVICE_CONNECTION)
                appType: 'webAppLinux'
                WebAppName: $(APP_PRD)
                ResourceGroupName: $(RG_PRD)
                SlotName: 'blue'
                packageForLinux: "$(Pipeline.Workspace)/drop/DotNetWebApp.zip"
                RuntimeStack: 'DOTNETCORE|8.0'
                DeploymentTypeLinux: 'oneDeploy'
                StartupCommand: 'dotnet DotNetWebApp.dll'

            
            - task: AzurePowerShell@5
              displayName: "Health Check – Blue Slot (Production)"
              inputs:
                azureSubscription: $(AZURE_SERVICE_CONNECTION)
                ScriptType: InlineScript
                Inline: |
                  $slotUrl = "https://$(APP_PRD)-blue.azurewebsites.net/health"
                  Write-Host "Checking Blue slot health: $slotUrl"

                  $maxRetries = 30
                  $delaySeconds = 10

                  for ($i = 1; $i -le $maxRetries; $i++) {
                      try {
                          $response = Invoke-WebRequest -Uri $slotUrl -TimeoutSec 10 -UseBasicParsing
                          if ($response.StatusCode -eq 200) {
                              Write-Host "Blue slot is healthy"
                              exit 0
                          }
                          Write-Host "Attempt $i → Status=$($response.StatusCode), retrying..."
                      } catch {
                          Write-Host "Attempt $i → Health check failed, retrying..."
                      }
                      Start-Sleep -Seconds $delaySeconds
                  }

                  Write-Error "Blue slot did not become healthy after $maxRetries attempts"
                  exit 1
                azurePowerShellVersion: LatestVersion

            - task: AzureAppServiceManage@0
              displayName: "Swap Blue → Production"
              inputs:
                azureSubscription: $(AZURE_SERVICE_CONNECTION)
                Action: 'Swap Slots'
                WebAppName: $(APP_PRD)
                ResourceGroupName: $(RG_PRD)
                SourceSlot: 'blue'
