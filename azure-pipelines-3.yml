trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: 'Release'
  PUBLISH_DIR: '$(Build.ArtifactStagingDirectory)/publish'
  ARTIFACT_NAME: 'drop'
  WEB_PROJECT: 'src/DotNetWebApp/DotNetWebApp.csproj'

  # App Names
  APP_DEV: 'mywebapp-dev-12345'
  APP_STG: 'mywebapp-staging-12345'
  APP_PRD: 'mywebapp-prod-12345'

  # Resource Groups
  RG_NONPROD: 'rg-staging-webapp'
  RG_PROD: 'rg-prod-webapp'

  # Service Connections
  AZURE_SERVICE_CONNECTION: 'Appconnec'

# ---------------------- CI -------------------------
stages:
- stage: Build_Test
  displayName: "CI â€” Build and Test"
  jobs:
  - job: BuildJob
    displayName: Build Job
    steps:

      # Restore
      - task: DotNetCoreCLI@2
        displayName: Restore
        inputs:
          command: 'restore'
          projects: 'src/DotNetWebApp/DotNetWebApp.csproj'
          feedsToUse: 'select'
          vstsFeed: '049291ea-8785-42f3-b7c8-c7c84cd3506d'

      # Build
      - task: DotNetCoreCLI@2
        displayName: Build
        inputs:
          command: 'build'
          projects: 'src/DotNetWebApp/DotNetWebApp.csproj'
          arguments: '--configuration $(BUILD_CONFIGURATION)'

      # Test
      - task: DotNetCoreCLI@2
        displayName: Test
        inputs:
          command: 'test'
          projects: 'tests/DotNetWebApp.Tests'
          arguments: '--logger trx'

      # Publish
      - task: DotNetCoreCLI@2
        displayName: Publish
        inputs:
          command: 'publish'
          projects: '$(WEB_PROJECT)'
          arguments: '-c $(BUILD_CONFIGURATION) -o $(PUBLISH_DIR)'

      # Create ZIP package
      - task: ArchiveFiles@2
        displayName: "Create ZIP Package"
        inputs:
          rootFolderOrFile: '$(PUBLISH_DIR)'
          includeRootFolder: false
          archiveFile: '$(Build.ArtifactStagingDirectory)/app.zip'
          replaceExistingArchive: true

      # Publish artifact
      - task: PublishPipelineArtifact@1
        displayName: Publish Artifact
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)'
          artifact: '$(ARTIFACT_NAME)'
