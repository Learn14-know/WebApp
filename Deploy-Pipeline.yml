trigger: none  # Manual trigger for CD

variables:
  # App Names
  APP_DEV: 'app-RG-DEV'
  APP_STG: 'app-RG-STAGING'
  APP_PRD: 'app-RG-PROD-App'

  # Resource Groups
  RG_DEV: 'RG-DEV'
  RG_STAGING: 'RG-STAGING'
  RG_PRD: 'RG-PROD-App'

  # Azure service connection
  AZURE_SERVICE_CONNECTION: 'Appconnec'

  # CI pipeline info
  CI_PROJECT: 'WebApp'                     # DevOps project name
  CI_PIPELINE_NAME: 'Learn14-know.WebApp' # CI pipeline name
  ARTIFACT_NAME: 'drop'                    # Artifact name in CI

stages:

# ---------------------- DEV DEPLOY -------------------------
- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  jobs:
  - deployment: DeployDev
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:

          # Download latest artifact from CI
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Latest CI Artifact'
            inputs:
              buildType: 'latest'
              project: $(CI_PROJECT)
              pipeline: $(CI_PIPELINE_NAME)
              artifact: $(ARTIFACT_NAME)
              targetPath: '$(Pipeline.Workspace)/drop'

          # Find app.zip dynamically
          - script: |
              echo "Searching for app.zip..."
              APP_ZIP=$(find $(Pipeline.Workspace)/drop -name "app.zip")
              if [ -z "$APP_ZIP" ]; then
                echo "##vso[task.logissue type=error]app.zip not found!"
                exit 1
              fi
              echo "Found app.zip at: $APP_ZIP"
              echo "##vso[task.setvariable variable=APP_ZIP_PATH]$APP_ZIP"
            displayName: 'Locate app.zip'

          # Deploy to Dev
          - task: AzureWebApp@1
            displayName: 'Deploy to Dev'
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_DEV)
              resourceGroupName: $(RG_DEV)
              package: '$(APP_ZIP_PATH)'

# ---------------------- STAGING DEPLOY -------------------------
- stage: Deploy_Staging
  displayName: "Deploy to Staging"
  dependsOn: Deploy_Dev
  jobs:
  - deployment: DeployStaging
    environment: staging
    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            displayName: 'Download Latest CI Artifact'
            inputs:
              buildType: 'latest'
              project: $(CI_PROJECT)
              pipeline: $(CI_PIPELINE_NAME)
              artifact: $(ARTIFACT_NAME)
              targetPath: '$(Pipeline.Workspace)/drop'

          - script: |
              echo "Searching for app.zip..."
              APP_ZIP=$(find $(Pipeline.Workspace)/drop -name "app.zip")
              if [ -z "$APP_ZIP" ]; then
                echo "##vso[task.logissue type=error]app.zip not found!"
                exit 1
              fi
              echo "Found app.zip at: $APP_ZIP"
              echo "##vso[task.setvariable variable=APP_ZIP_PATH]$APP_ZIP"
            displayName: 'Locate app.zip'

          - task: AzureWebApp@1
            displayName: 'Deploy to Staging'
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_STG)
              resourceGroupName: $(RG_STAGING)
              package: '$(APP_ZIP_PATH)'

# ---------------------- PRODUCTION BLUE-GREEN -------------------------
- stage: Deploy_Prod
  displayName: "Deploy to Production"
  dependsOn: Deploy_Staging
  jobs:
  - deployment: DeployProd
    environment: production
    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            displayName: 'Download Latest CI Artifact'
            inputs:
              buildType: 'specific'
              project: $(CI_PROJECT)
              pipeline: $(CI_PIPELINE_NAME)
              artifact: $(ARTIFACT_NAME)
              targetPath: '$(Pipeline.Workspace)/drop'

          - script: |
              echo "Searching for app.zip..."
              APP_ZIP=$(find $(Pipeline.Workspace)/drop -name "app.zip")
              if [ -z "$APP_ZIP" ]; then
                echo "##vso[task.logissue type=error]app.zip not found!"
                exit 1
              fi
              echo "Found app.zip at: $APP_ZIP"
              echo "##vso[task.setvariable variable=APP_ZIP_PATH]$APP_ZIP"
            displayName: 'Locate app.zip'

          # Deploy to Production Slot (Blue)
          - task: AzureWebApp@1
            displayName: 'Deploy to Production Slot (Blue)'
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_PRD)
              resourceGroupName: $(RG_PRD)
              slotName: blue
              package: '$(APP_ZIP_PATH)'

          # Swap Blue -> Production
          - task: AzureAppServiceManage@0
            displayName: 'Swap Blue Slot Into Production'
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              WebAppName: $(APP_PRD)
              ResourceGroupName: $(RG_PRD)
              SourceSlot: blue
              TargetSlot: production
