trigger: none

pool:
  vmImage: ubuntu-latest

variables:
  ARTIFACT_NAME: 'drop'
  AZURE_SERVICE_CONNECTION: 'Appconnec'
  RG_DEV: 'RG-DEV'
  RG_STAGING: 'RG-STAGING'
  RG_PROD: 'RG-PROD-App'
  APP_DEV: 'app-dev-app'
  APP_STG: 'app-staging-app'
  APP_PRD: 'app-prod-app'
  HEALTHCHECK_URL: '/health'

resources:
  pipelines:
    - pipeline: CI_Build
      source: Learn14-know.WebApp
      trigger: true

# ---------------------------------------------------------------------
# 1. DOWNLOAD ARTIFACT + FULL DEBUG
# ---------------------------------------------------------------------

stages:
- stage: Download_Artifact
  displayName: "Download Artifact + DEBUG"
  jobs:
    - job: Download
      displayName: "Download Build Artifact"
      steps:

        - download: CI_Build
          artifact: $(ARTIFACT_NAME)
          displayName: "Download CI Artifact"

        # üî• FULL DEBUG: Show workspace + artifact structure
        - script: |
            echo "====================== DEBUG START ======================"
            echo "Pipeline.Workspace:"
            echo "$(Pipeline.Workspace)"
            echo ""

            echo "Listing Workspace root:"
            ls -al "$(Pipeline.Workspace)"
            echo ""

            echo "Recursive workspace listing:"
            ls -R "$(Pipeline.Workspace)"
            echo ""

            echo "Expected artifact folder:"
            echo "$(Pipeline.Workspace)/$(ARTIFACT_NAME)"
            echo ""

            if [ -d "$(Pipeline.Workspace)/$(ARTIFACT_NAME)" ]; then
              echo "Artifact directory exists"
              ls -al "$(Pipeline.Workspace)/$(ARTIFACT_NAME)"
            else
              echo "‚ùå Artifact directory NOT FOUND at: $(Pipeline.Workspace)/$(ARTIFACT_NAME)"
            fi

            echo "====================== DEBUG END ======================"
          displayName: "DEBUG ‚Äî Locate Artifact"

# ---------------------------------------------------------------------
# 2. DEPLOY TO DEV
# ---------------------------------------------------------------------

- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  dependsOn: Download_Artifact
  jobs:
    - deployment: DeployDev
      environment: dev
      strategy:
        runOnce:
          deploy:
            steps:

              - download: current
                artifact: $(ARTIFACT_NAME)

              - task: AzureWebApp@1
                displayName: "Deploy to Dev App Service"
                inputs:
                  azureSubscription: $(AZURE_SERVICE_CONNECTION)
                  appName: $(APP_DEV)
                  resourceGroupName: $(RG_DEV)
                  package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/app.zip"

# ---------------------------------------------------------------------
# 3. DEPLOY TO STAGING (GREEN SLOT)
# ---------------------------------------------------------------------

- stage: Deploy_Staging
  displayName: "Deploy to Staging"
  dependsOn: Deploy_Dev
  jobs:
    - deployment: DeployStg
      environment: staging
      strategy:
        runOnce:
          deploy:
            steps:

              - download: current
                artifact: $(ARTIFACT_NAME)

              - task: AzureWebApp@1
                displayName: "Deploy to GREEN slot"
                inputs:
                  azureSubscription: $(AZURE_SERVICE_CONNECTION)
                  appName: $(APP_STG)
                  resourceGroupName: $(RG_STAGING)
                  slotName: "green"
                  package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/app.zip"

              - task: PowerShell@2
                displayName: "Health Check GREEN"
                inputs:
                  targetType: 'inline'
                  script: |
                    $url = "https://$(APP_STG)-green.azurewebsites.net$(HEALTHCHECK_URL)"
                    Write-Host "Checking health: $url"
                    for ($i=1; $i -le 12; $i++) {
                      try {
                        $r = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10 -SkipCertificateCheck
                        if ($r.StatusCode -eq 200) { exit 0 }
                      } catch {}
                      Start-Sleep 10
                    }
                    Write-Error "Health check failed"
                    exit 1

              - task: AzureAppServiceManage@0
                displayName: "Swap GREEN ‚Üí Prod"
                inputs:
                  azureSubscription: $(AZURE_SERVICE_CONNECTION)
                  WebAppName: $(APP_STG)
                  ResourceGroupName: $(RG_STAGING)
                  SourceSlot: green
                  TargetSlot: production

# ---------------------------------------------------------------------
# 4. DEPLOY TO PRODUCTION (BLUE SLOT)
# ---------------------------------------------------------------------

- stage: Deploy_Prod
  displayName: "Deploy to Production"
  dependsOn: Deploy_Staging
  jobs:
    - deployment: DeployProd
      environment: production
      strategy:
        runOnce:
          deploy:
            steps:

              - download: current
                artifact: $(ARTIFACT_NAME)

              - task: AzureWebApp@1
                displayName: "Deploy to BLUE slot"
                inputs:
                  azureSubscription: $(AZURE_SERVICE_CONNECTION)
                  appName: $(APP_PRD)
                  resourceGroupName: $(RG_PROD)
                  slotName: "blue"
                  package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/app.zip"

              - task: PowerShell@2
                displayName: "Health Check BLUE"
                inputs:
                  targetType: 'inline'
                  script: |
                    $url = "https://$(APP_PRD)-blue.azurewebsites.net$(HEALTHCHECK_URL)"
                    Write-Host "Checking health: $url"
                    for ($i=1; $i -le 12; $i++) {
                      try {
                        $r = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10 -SkipCertificateCheck
                        if ($r.StatusCode -eq 200) { exit 0 }
                      } catch {}
                      Start-Sleep 10
                    }
                    Write-Error "Health check failed"
                    exit 1

              - task: AzureAppServiceManage@0
                displayName: "Swap BLUE ‚Üí LIVE"
                inputs:
                  azureSubscription: $(AZURE_SERVICE_CONNECTION)
                  WebAppName: $(APP_PRD)
                  ResourceGroupName: $(RG_PROD)
                  SourceSlot: blue
                  TargetSlot: production
