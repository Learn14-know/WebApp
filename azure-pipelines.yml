trigger: none

pool:
  vmImage: ubuntu-latest

variables:
  ARTIFACT_NAME: 'drop'
  AZURE_SERVICE_CONNECTION: 'Appconnec'
  RG_DEV: 'RG-DEV'
  RG_STAGING: 'RG-STAGING'
  RG_PROD: 'RG-PROD-App'
  APP_DEV: 'app-dev-app'
  APP_STG: 'app-staging-app'
  APP_PRD: 'app-prod-app'
  HEALTHCHECK_URL: '/health'

resources:
  pipelines:
    - pipeline: ci
      source: "Learn14-know.WebApp"
      trigger: true

# --------------------- Download Artifact ---------------------
stages:
  - stage: Download_Artifact
    displayName: "Download Artifact"
    jobs:
      - job: Download
        displayName: "Download Artifact Job"
        steps:
          - download: ci
            artifact: $(ARTIFACT_NAME)
            displayName: "Download CI Artifact"

          - script: |
              echo "Pipeline.Workspace: $(Pipeline.Workspace)"
              echo "Listing workspace root:"
              ls -R $(Pipeline.Workspace)
              echo "Listing artifact folder:"
              ls -R $(Pipeline.Workspace)/$(ARTIFACT_NAME)
            displayName: "Debug - List Artifact Files"

# --------------------- Deploy to Dev ---------------------
  - stage: Deploy_Dev
    displayName: "Deploy to Dev"
    dependsOn: Download_Artifact
    jobs:
      - deployment: DeployDev
        environment: dev
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: $(ARTIFACT_NAME)
                  displayName: "Download artifact from previous stage"

                - task: AzureWebApp@1
                  displayName: "Deploy to Dev App Service"
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    appName: $(APP_DEV)
                    resourceGroupName: $(RG_DEV)
                    package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/DotNetWebApp.zip"

# --------------------- Deploy to Staging (Green slot) ---------------------
  - stage: Deploy_Staging
    displayName: "Deploy to Staging (Green slot)"
    dependsOn: Deploy_Dev
    jobs:
      - deployment: DeployStg
        environment: staging
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: $(ARTIFACT_NAME)
                  displayName: "Download artifact from previous stage"

                - task: AzureWebApp@1
                  displayName: "Deploy to GREEN slot"
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    appName: $(APP_STG)
                    resourceGroupName: $(RG_STAGING)
                    slotName: "green"
                    package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/DotNetWebApp.zip"

                - task: PowerShell@2
                  displayName: "Health Check on GREEN slot"
                  inputs:
                    targetType: 'inline'
                    script: |
                      $url = "https://$(APP_STG)-green.azurewebsites.net$(HEALTHCHECK_URL)"
                      for ($i=0; $i -lt 12; $i++) {
                          try {
                              $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
                              if ($resp.StatusCode -eq 200) { exit 0 }
                          } catch {}
                          Start-Sleep -Seconds 10
                      }
                      Write-Error "Health check failed after multiple attempts"
                      exit 1

                - task: AzureAppServiceManage@0
                  displayName: "Swap GREEN slot into Production"
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    WebAppName: $(APP_STG)
                    ResourceGroupName: $(RG_STAGING)
                    SourceSlot: green
                    TargetSlot: production

# --------------------- Deploy to Production (Blue slot) ---------------------
  - stage: Deploy_Prod
    displayName: "Deploy to Production (Blue slot)"
    dependsOn: Deploy_Staging
    jobs:
      - deployment: DeployProd
        environment: production
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: $(ARTIFACT_NAME)
                  displayName: "Download artifact from previous stage"

                - task: AzureWebApp@1
                  displayName: "Deploy to BLUE slot"
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    appName: $(APP_PRD)
                    resourceGroupName: $(RG_PROD)
                    slotName: "blue"
                    package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/DotNetWebApp.zip"

                - task: PowerShell@2
                  displayName: "Health Check on BLUE slot"
                  inputs:
                    targetType: 'inline'
                    script: |
                      $url = "https://$(APP_PRD)-blue.azurewebsites.net$(HEALTHCHECK_URL)"
                      for ($i=0; $i -lt 12; $i++) {
                          try {
                              $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
                              if ($resp.StatusCode -eq 200) { exit 0 }
                          } catch {}
                          Start-Sleep -Seconds 10
                      }
                      Write-Error "Health check failed after multiple attempts"
                      exit 1

                - task: AzureAppServiceManage@0
                  displayName: "Swap BLUE slot into LIVE Production"
                  inputs:
                    azureSubscription: $(AZURE_SERVICE_CONNECTION)
                    WebAppName: $(APP_PRD)
                    ResourceGroupName: $(RG_PROD)
                    SourceSlot: blue
                    TargetSlot: production
