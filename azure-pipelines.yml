trigger: none  # CD pipeline runs manually or triggered via CI artifact

variables:
  # App Names
  APP_DEV: 'app-RG-DEV'
  APP_STG: 'app-RG-STAGING'
  APP_PRD: 'app-RG-PROD-App'

  # Resource Groups
  RG_DEV: 'RG-DEV'
  RG_STAGING: 'RG-STAGING'
  RG_PROD: 'RG-PROD-App'

  # Azure service connection
  AZURE_SERVICE_CONNECTION: 'Appconnec'

  # CI pipeline info
  CI_PROJECT: 'Learn14-know/WebApp'       # Exact project path
  CI_PIPELINE_NAME: 'CI-Build and Test'   # Exact CI pipeline name
  ARTIFACT_NAME: 'drop'

stages:

# ---------------------- DEV DEPLOY -------------------------
- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  jobs:
  - deployment: DeployDev
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifact from CI'
            inputs:
              project: '$(CI_PROJECT)'
              pipeline: '$(CI_PIPELINE_NAME)'
              buildType: 'latest'
              artifact: '$(ARTIFACT_NAME)'
              targetPath: '$(Pipeline.Workspace)/drop'

          - task: AzureWebApp@1
            displayName: 'Deploy to Dev'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              appName: '$(APP_DEV)'
              resourceGroupName: '$(RG_DEV)'
              package: '$(Pipeline.Workspace)/drop/app.zip'

# ---------------------- STAGING DEPLOY -------------------------
- stage: Deploy_Staging
  displayName: "Deploy to Staging"
  dependsOn: Deploy_Dev
  jobs:
  - deployment: DeployStaging
    environment: staging
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifact from CI'
            inputs:
              project: '$(CI_PROJECT)'
              pipeline: '$(CI_PIPELINE_NAME)'
              buildType: 'latest'
              artifact: '$(ARTIFACT_NAME)'
              targetPath: '$(Pipeline.Workspace)/drop'

          - task: AzureWebApp@1
            displayName: 'Deploy to Staging'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              appName: '$(APP_STG)'
              resourceGroupName: '$(RG_STAGING)'
              package: '$(Pipeline.Workspace)/drop/app.zip'

# ---------------------- PRODUCTION BLUE-GREEN -------------------------
- stage: Deploy_Prod
  displayName: "Deploy to Production"
  dependsOn: Deploy_Staging
  jobs:
  - deployment: DeployProd
    environment: production
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifact from CI'
            inputs:
              project: '$(CI_PROJECT)'
              pipeline: '$(CI_PIPELINE_NAME)'
              buildType: 'latest'
              artifact: '$(ARTIFACT_NAME)'
              targetPath: '$(Pipeline.Workspace)/drop'

          # Deploy to Production Slot (Blue)
          - task: AzureWebApp@1
            displayName: 'Deploy to Production Slot (Blue)'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              appName: '$(APP_PRD)'
              resourceGroupName: '$(RG_PROD)'
              slotName: blue
              package: '$(Pipeline.Workspace)/drop/app.zip'

          # Swap Blue -> Production
          - task: AzureAppServiceManage@0
            displayName: 'Swap Blue Slot Into Production'
            inputs:
              azureSubscription: '$(AZURE_SERVICE_CONNECTION)'
              WebAppName: '$(APP_PRD)'
              ResourceGroupName: '$(RG_PROD)'
              SourceSlot: blue
              TargetSlot: production
