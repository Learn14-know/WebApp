trigger: none  # CD triggered manually or via artifact from CI

pool:
  vmImage: ubuntu-latest

variables:
  ARTIFACT_NAME: 'drop'
  AZURE_SERVICE_CONNECTION: 'Appconnec'
  RG_DEV: 'RG-DEV'
  RG_STAGING: 'RG-STAGING'
  RG_PROD: 'RG-PROD-App'
  APP_DEV: 'app-dev-app'
  APP_STG: 'app-staging-app'
  APP_PRD: 'app-prod-app'
  HEALTHCHECK_URL: '/health'

resources:
  pipelines:
    - pipeline: CI_Build
      source: Learn14-know.WebApp
      trigger: true

stages:

- stage: CD_Deploy
  displayName: "CD Pipeline – Dev, Staging, Production"
  jobs:

  ##########################################
  # 1️⃣ Deploy to Dev
  ##########################################
  - deployment: DeployDev
    displayName: "Deploy to Dev"
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:
          # Download artifact once
          - download: CI_Build
            artifact: $(ARTIFACT_NAME)
            displayName: "Download Build Artifact"

          # Deploy to Dev App Service
          - task: AzureWebApp@1
            displayName: "Deploy to Dev App Service"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_DEV)
              resourceGroupName: $(RG_DEV)
              package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/app.zip"

  ##########################################
  # 2️⃣ Deploy to Staging – Green slot → Production
  ##########################################
  - deployment: DeployStaging
    displayName: "Deploy to Staging (Green slot)"
    environment: staging
    strategy:
      runOnce:
        deploy:
          steps:
          # Deploy to GREEN slot
          - task: AzureWebApp@1
            displayName: "Deploy to GREEN slot (Staging)"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_STG)
              resourceGroupName: $(RG_STAGING)
              slotName: "green"
              package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/app.zip"

          # Health check on GREEN slot
          - task: PowerShell@2
            displayName: "Health Check on Staging GREEN slot"
            inputs:
              targetType: 'inline'
              script: |
                $url = "https://$(APP_STG)-green.azurewebsites.net$(HEALTHCHECK_URL)"
                for ($i=0; $i -lt 12; $i++) {
                    try {
                        $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
                        if ($resp.StatusCode -eq 200) { exit 0 }
                    } catch {}
                    Start-Sleep -Seconds 10
                }
                Write-Error "Health check failed after multiple attempts"
                exit 1

          # Swap GREEN → Production slot
          - task: AzureAppServiceManage@0
            displayName: "Swap GREEN slot into Staging Production"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              WebAppName: $(APP_STG)
              ResourceGroupName: $(RG_STAGING)
              SourceSlot: green
              TargetSlot: production

  ##########################################
  # 3️⃣ Deploy to Production – Blue slot → Production
  ##########################################
  - deployment: DeployProd
    displayName: "Deploy to Production (Blue slot)"
    environment: production
    strategy:
      runOnce:
        deploy:
          steps:
          # Deploy to BLUE slot
          - task: AzureWebApp@1
            displayName: "Deploy to BLUE slot (Production)"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_PRD)
              resourceGroupName: $(RG_PROD)
              slotName: "blue"
              package: "$(Pipeline.Workspace)/$(ARTIFACT_NAME)/app.zip"

          # Health check on BLUE slot
          - task: PowerShell@2
            displayName: "Health Check on Production BLUE slot"
            inputs:
              targetType: 'inline'
              script: |
                $url = "https://$(APP_PRD)-blue.azurewebsites.net$(HEALTHCHECK_URL)"
                for ($i=0; $i -lt 12; $i++) {
                    try {
                        $resp = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
                        if ($resp.StatusCode -eq 200) { exit 0 }
                    } catch {}
                    Start-Sleep -Seconds 10
                }
                Write-Error "Health check failed after multiple attempts"
                exit 1

          # Swap BLUE → Production slot
          - task: AzureAppServiceManage@0
            displayName: "Swap BLUE slot into LIVE Production"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              WebAppName: $(APP_PRD)
              ResourceGroupName: $(RG_PROD)
              SourceSlot: blue
              TargetSlot: production
