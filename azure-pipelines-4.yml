trigger: none   # CD pipeline runs manually or via CI artifact

variables:
  # App Names
  APP_DEV: 'app-RG-DEV'
  APP_STG: 'app-RG-STAGING'
  APP_PRD: 'app-RG-PROD-App'

  # Resource Groups
  RG_DEV: 'RG-DEV'
  RG_STAGING: 'RG-STAGING'
  RG_PROD: 'RG-PROD-App'

  # Azure service connection
  AZURE_SERVICE_CONNECTION: 'Appconnec'

  # CI pipeline info
  CI_PROJECT: 'NCPLprojectAzure/WebApp'   # Your DevOps project
  CI_PIPELINE_ID: '389'   # Exact pipeline name
  ARTIFACT_NAME: 'drop'                   # Name of the artifact published in CI

stages:

# ---------------------- DEV DEPLOY -------------------------
- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  jobs:
  - deployment: DeployDev
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:

          # Download latest artifact from CI
          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifact from CI'
            inputs:
              source: 'specific'
              project: $(CI_PROJECT)
              pipeline: $(CI_PIPELINE_ID)
              buildVersionToDownload: 'latest'
              artifact: $(ARTIFACT_NAME)
              targetPath: '$(Pipeline.Workspace)/drop'

          # Deploy to Dev
          - task: AzureWebApp@1
            displayName: 'Deploy to Dev'
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_DEV)
              resourceGroupName: $(RG_DEV)
              package: '$(Pipeline.Workspace)/drop/app.zip'

# ---------------------- STAGING DEPLOY -------------------------
- stage: Deploy_Staging
  displayName: "Deploy to Staging"
  dependsOn: Deploy_Dev
  jobs:
  - deployment: DeployStaging
    environment: staging
    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifact from CI'
            inputs:
              source: 'specific'
              project: $(CI_PROJECT)
              pipeline: $(CI_PIPELINE_NAME)
              buildVersionToDownload: 'latest'
              artifact: $(ARTIFACT_NAME)
              targetPath: '$(Pipeline.Workspace)/drop'

          - task: AzureWebApp@1
            displayName: 'Deploy to Staging'
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_STG)
              resourceGroupName: $(RG_STAGING)
              package: '$(Pipeline.Workspace)/drop/app.zip'

# ---------------------- PRODUCTION BLUE-GREEN -------------------------
- stage: Deploy_Prod
  displayName: "Deploy to Production"
  dependsOn: Deploy_Staging
  jobs:
  - deployment: DeployProd
    environment: production
    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            displayName: 'Download Build Artifact from CI'
            inputs:
              source: 'specific'
              project: $(CI_PROJECT)
              pipeline: $(CI_PIPELINE_ID)
              buildVersionToDownload: 'latest'
              artifact: $(ARTIFACT_NAME)
              targetPath: '$(Pipeline.Workspace)/drop'

          # Deploy to Production Slot (Blue)
          - task: AzureWebApp@1
            displayName: 'Deploy to Production Slot (Blue)'
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_PRD)
              resourceGroupName: $(RG_PROD)
              slotName: blue
              package: '$(Pipeline.Workspace)/drop/app.zip'

          # Swap Blue -> Production
          - task: AzureAppServiceManage@0
            displayName: 'Swap Blue Slot Into Production'
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              WebAppName: $(APP_PRD)
              ResourceGroupName: $(RG_PROD)
              SourceSlot: blue
              TargetSlot: production
