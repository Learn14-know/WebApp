trigger: none   # CD runs manually

variables:
  # Azure DevOps project & CI pipeline
  PROJECT_NAME: 'WebApp'
  CI_PIPELINE_NAME: 'Learn14-know.WebApp'
  ARTIFACT_NAME: 'drop'

  # App Names
  APP_DEV: 'app-RG-DEV'
  APP_STG: 'app-RG-STAGING'
  APP_PRD: 'app-RG-PROD-App'

  # Resource Groups
  RG_DEV: 'RG-DEV'
  RG_STAGING: 'RG-STAGING'
  RG_PROD: 'RG-PROD-App'

  # Azure service connection
  AZURE_SERVICE_CONNECTION: 'Appconnec'

stages:

# -----------------------------------------------------------
# DEV DEPLOYMENT
# -----------------------------------------------------------
- stage: Deploy_Dev
  displayName: "Deploy to Dev"
  jobs:
  - deployment: DeployDev
    environment: dev
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: "Download CI Artifact"
            inputs:
              project: $(PROJECT_NAME)
              pipeline: $(CI_PIPELINE_NAME)
              buildVersionToDownload: latest
              artifact: $(ARTIFACT_NAME)
              path: "$(Pipeline.Workspace)/drop"

          - task: AzureWebApp@1
            displayName: "Deploy to Dev Web App"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_DEV)
              resourceGroupName: $(RG_DEV)
              package: "$(Pipeline.Workspace)/drop/app.zip"

# -----------------------------------------------------------
# STAGING DEPLOYMENT
# -----------------------------------------------------------
- stage: Deploy_Staging
  displayName: "Deploy to Staging"
  dependsOn: Deploy_Dev
  jobs:
  - deployment: DeployStaging
    environment: staging
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@2
            displayName: "Download CI Artifact"
            inputs:
              project: $(PROJECT_NAME)
              pipeline: $(CI_PIPELINE_NAME)
              buildVersionToDownload: latest
              artifact: $(ARTIFACT_NAME)
              path: "$(Pipeline.Workspace)/drop"

          - task: AzureWebApp@1
            displayName: "Deploy to Staging Web App"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_STG)
              resourceGroupName: $(RG_STAGING)
              package: "$(Pipeline.Workspace)/drop/app.zip"

# -----------------------------------------------------------
# PRODUCTION BLUE-GREEN DEPLOYMENT
# -----------------------------------------------------------
- stage: Deploy_Prod
  displayName: "Deploy to Production"
  dependsOn: Deploy_Staging
  jobs:
  - deployment: DeployProd
    environment: production
    strategy:
      runOnce:
        deploy:
          steps:

          - task: DownloadPipelineArtifact@2
            displayName: "Download CI Artifact"
            inputs:
              project: $(PROJECT_NAME)
              pipeline: $(CI_PIPELINE_NAME)
              buildVersionToDownload: latest
              artifact: $(ARTIFACT_NAME)
              path: "$(Pipeline.Workspace)/drop"

          # Deploy to BLUE slot
          - task: AzureWebApp@1
            displayName: "Deploy to Blue Slot"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              appName: $(APP_PRD)
              resourceGroupName: $(RG_PROD)
              slotName: blue
              package: "$(Pipeline.Workspace)/drop/app.zip"

          # Swap BLUE â†’ PRODUCTION
          - task: AzureAppServiceManage@0
            displayName: "Swap Blue into Production"
            inputs:
              azureSubscription: $(AZURE_SERVICE_CONNECTION)
              WebAppName: $(APP_PRD)
              ResourceGroupName: $(RG_PROD)
              SourceSlot: blue
              TargetSlot: production
